<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <title>Office JavaScript API Helpers Sample</title>
    <script src="https://ajax.aspnetcdn.com/ajax/jquery/jquery-3.1.1.min.js"></script>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://unpkg.com/core-js/client/core.min.js"></script>
    <script src="https://unpkg.com/@microsoft/office-js-helpers@0.5.0/dist/office.helpers.min.js"></script>
    <script>
      var authenticator;
      var client_id = "アプリケーション ID(クライアント ID)";
      var redirect_url = "リダイレクト URL";
      var scope = "https://graph.microsoft.com/user.read";
      var access_token;
       
      Office.initialize = function(reason){
        if(OfficeHelpers.Authenticator.isAuthDialog()) return;
      }
       
      $(function(){
        authenticator = new OfficeHelpers.Authenticator();
         
        //access_token取得
        $("#login").click(function(){
          authenticator.endpoints.registerMicrosoftAuth(client_id, {
            redirectUrl: redirect_url,
            scope: scope
          });
          authenticator.authenticate(OfficeHelpers.DefaultEndpoints.Microsoft)
            .then(function(token){
              access_token = token.access_token;
              $("#exec").prop("disabled", false);
            })
            .catch(OfficeHelpers.Utilities.log);
        });
         
        //API呼び出し
        $("#exec").click(function(){
          $.ajax({
            url: "https://graph.microsoft.com/v1.0/me",
            type: "GET",
            beforeSend: function(xhr){
              xhr.setRequestHeader("Authorization", "Bearer " + access_token);
            },
            success: function(data){
              //console.log(data); //確認用
              Excel.run(function(ctx){
                //アクティブセルにユーザー名入力
                ctx.workbook.getSelectedRange().values = data.displayName;
                return ctx.sync();
              }).catch(function(error){
                console.log(error);
              });
               
            },
            error: function(data){
              console.log(data);
            }
          });
        });
         
      });
    </script>
  </head>
  <body>
    <div id="contents">
      <button id="login">Login</button>
      <button id="exec" disabled="disabled">Execute</button>
    </div>
  </body>
</html>
